---
description: Guidline for integrating Google Meet and Google Calendar in the learning live sessions features.
alwaysApply: false
---
# Google Calendar & Meet Integration Guide

## Google Calendar API Setup

### Service Account Configuration
```php
// ✅ DO: Create a dedicated Google service class
class GoogleCalendarService {
    protected Google_Client $client;
    protected Google_Service_Calendar $service;
    
    public function __construct() {
        $this->client = new Google_Client();
        $this->client->setAuthConfig(storage_path('app/google-calendar/credentials.json'));
        $this->client->addScope(Google_Service_Calendar::CALENDAR);
        $this->service = new Google_Service_Calendar($this->client);
    }
}
```

### OAuth 2.0 Authentication Flow
```php
// ✅ DO: Implement proper OAuth flow for user calendars
public function redirectToGoogle(): RedirectResponse {
    $authUrl = $this->client->createAuthUrl();
    return redirect($authUrl);
}

public function handleCallback(Request $request) {
    $this->client->authenticate($request->get('code'));
    $token = $this->client->getAccessToken();
    
    // Store token securely per user/tenant
    auth()->user()->update([
        'google_calendar_token' => encrypt($token)
    ]);
}
```

## Google Meet Link Generation

### Conference Data Structure
```php
// ✅ DO: Use proper conferenceData structure for Meet links
public function createEventWithMeetLink(array $eventData): Google_Service_Calendar_Event {
    $event = new Google_Service_Calendar_Event([
        'summary' => $eventData['title'],
        'start' => ['dateTime' => $eventData['start_time']],
        'end' => ['dateTime' => $eventData['end_time']],
        'conferenceData' => [
            'createRequest' => [
                'requestId' => Str::uuid()->toString(),
                'conferenceSolutionKey' => [
                    'type' => 'hangoutsMeet'
                ]
            ]
        ]
    ]);
    
    return $this->service->events->insert(
        $calendarId, 
        $event, 
        ['conferenceDataVersion' => 1]
    );
}
```

### Meet Link Requirements
```php
// ✅ DO: Always include conferenceDataVersion parameter
$options = ['conferenceDataVersion' => 1];
$event = $service->events->insert($calendarId, $event, $options);

// ✅ DO: Generate unique request IDs
'requestId' => 'session_' . time() . '_' . Str::random(8)

// ✅ DO: Set proper conference solution key
'conferenceSolutionKey' => ['type' => 'hangoutsMeet']
```

## Session Scheduling Integration

### Automated Session Creation
```php
// ✅ DO: Create job for session scheduling
class CreateGoogleMeetSessionJob implements ShouldQueue {
    public function __construct(
        private Session $session,
        private string $teacherEmail,
        private array $attendeeEmails
    ) {}
    
    public function handle(GoogleCalendarService $calendar): void {
        $event = $calendar->createEvent([
            'summary' => "درس {$this->session->subject->name}",
            'description' => "جلسة مع الأستاذ {$this->session->teacher->name}",
            'start' => $this->session->start_time->toISOString(),
            'end' => $this->session->end_time->toISOString(),
            'attendees' => array_map(fn($email) => ['email' => $email], $this->attendeeEmails),
            'conferenceData' => [
                'createRequest' => [
                    'requestId' => "session_{$this->session->id}",
                    'conferenceSolutionKey' => ['type' => 'hangoutsMeet']
                ]
            ]
        ]);
        
        $this->session->update([
            'google_event_id' => $event->getId(),
            'meet_url' => $event->getHangoutLink()
        ]);
    }
}
```

### Pre-Session Link Preparation
```php
// ✅ DO: Generate Meet links 15 minutes before session
class GenerateMeetLinksCommand extends Command {
    public function handle(): void {
        $upcomingSessions = Session::where('start_time', '>=', now())
            ->where('start_time', '<=', now()->addMinutes(15))
            ->whereNull('meet_url')
            ->get();
            
        foreach ($upcomingSessions as $session) {
            CreateGoogleMeetSessionJob::dispatch($session);
        }
    }
}
```

## Error Handling & Retry Logic

### Token Refresh Handling
```php
// ✅ DO: Handle token expiration gracefully
public function refreshTokenIfNeeded(User $user): void {
    $token = decrypt($user->google_calendar_token);
    $this->client->setAccessToken($token);
    
    if ($this->client->isAccessTokenExpired()) {
        $refreshToken = $this->client->getRefreshToken();
        $this->client->fetchAccessTokenWithRefreshToken($refreshToken);
        
        $newToken = $this->client->getAccessToken();
        $user->update([
            'google_calendar_token' => encrypt($newToken)
        ]);
    }
}
```

### API Rate Limiting
```php
// ✅ DO: Implement rate limiting and retry logic
public function createEventWithRetry(array $eventData, int $maxRetries = 3): ?Google_Service_Calendar_Event {
    $attempt = 0;
    
    while ($attempt < $maxRetries) {
        try {
            return $this->service->events->insert($calendarId, $event, $options);
        } catch (Google_Service_Exception $e) {
            if ($e->getCode() === 429) { // Rate limit
                sleep(pow(2, $attempt)); // Exponential backoff
                $attempt++;
                continue;
            }
            throw $e;
        }
    }
    
    return null;
}
```

## Multi-Tenancy Considerations

### Tenant-Specific Calendar Access
```php
// ✅ DO: Ensure tenant isolation for calendar operations
class TenantAwareGoogleCalendarService extends GoogleCalendarService {
    public function __construct(private string $tenantId) {
        parent::__construct();
        $this->setTenantCredentials();
    }
    
    private function setTenantCredentials(): void {
        $credentials = TenantSetting::where('tenant_id', $this->tenantId)
            ->where('key', 'google_calendar_credentials')
            ->first();
            
        if ($credentials) {
            $this->client->setAuthConfig(json_decode($credentials->value, true));
        }
    }
}
```

## Webhook & Event Synchronization

### Calendar Event Sync
```php
// ✅ DO: Implement webhook handling for calendar changes
class GoogleCalendarWebhookController extends Controller {
    public function handle(Request $request): Response {
        $channelId = $request->header('X-Goog-Channel-Id');
        $resourceState = $request->header('X-Goog-Resource-State');
        
        if ($resourceState === 'sync') {
            return response('ok', 200);
        }
        
        // Handle calendar updates
        SyncCalendarEventsJob::dispatch($channelId);
        
        return response('ok', 200);
    }
}
```

### Event Update Synchronization
```php
// ✅ DO: Keep local events in sync with Google Calendar
class SyncCalendarEventsJob implements ShouldQueue {
    public function handle(string $channelId): void {
        $sessions = Session::where('google_channel_id', $channelId)->get();
        
        foreach ($sessions as $session) {
            try {
                $googleEvent = $this->calendar->getEvent($session->google_event_id);
                
                $session->update([
                    'start_time' => Carbon::parse($googleEvent->getStart()->getDateTime()),
                    'end_time' => Carbon::parse($googleEvent->getEnd()->getDateTime()),
                    'meet_url' => $googleEvent->getHangoutLink(),
                ]);
            } catch (Google_Service_Exception $e) {
                if ($e->getCode() === 404) {
                    // Event was deleted in Google Calendar
                    $session->update(['google_event_id' => null, 'meet_url' => null]);
                }
            }
        }
    }
}
```

## Security Best Practices

### Credential Management
```php
// ✅ DO: Store credentials securely
// In .env
GOOGLE_CALENDAR_CREDENTIALS_PATH=storage/app/google-calendar/credentials.json

// ✅ DO: Encrypt sensitive tokens
'google_calendar_token' => 'encrypted',

// ✅ DO: Use service account for server-to-server operations
$this->client->useApplicationDefaultCredentials();
```

### Access Control
```php
// ✅ DO: Verify user permissions for calendar operations
public function createSession(CreateSessionRequest $request): JsonResponse {
    $this->authorize('create', Session::class);
    
    // Additional checks for Google Calendar integration
    if (!auth()->user()->hasValidGoogleCalendarToken()) {
        return response()->json([
            'message' => 'يرجى ربط حسابك مع Google Calendar أولاً'
        ], 400);
    }
    
    // Proceed with session creation
}
```

## Testing Calendar Integration

### Mock Google Services in Tests
```php
// ✅ DO: Mock Google Calendar service in tests
class CalendarIntegrationTest extends TestCase {
    public function test_creates_session_with_meet_link(): void {
        $mockService = Mockery::mock(Google_Service_Calendar::class);
        $mockEvent = Mockery::mock(Google_Service_Calendar_Event::class);
        
        $mockEvent->shouldReceive('getId')->andReturn('event_123');
        $mockEvent->shouldReceive('getHangoutLink')
                  ->andReturn('https://meet.google.com/abc-def-ghi');
        
        $mockService->events = Mockery::mock();
        $mockService->events->shouldReceive('insert')
                           ->andReturn($mockEvent);
        
        app()->instance(Google_Service_Calendar::class, $mockService);
        
        // Test session creation
        $response = $this->postJson('/api/sessions', [
            'title' => 'Test Session',
            'start_time' => now()->addHour(),
            'end_time' => now()->addHours(2),
        ]);
        
        $response->assertStatus(201);
        $this->assertNotNull(Session::first()->meet_url);
    }
}
```

## Performance Optimization

### Batch Operations
```php
// ✅ DO: Batch calendar operations when possible
public function createMultipleSessions(array $sessions): void {
    $batch = new Google_Http_Batch($this->client);
    
    foreach ($sessions as $sessionData) {
        $event = new Google_Service_Calendar_Event($sessionData);
        $request = $this->service->events->insert($calendarId, $event);
        $batch->add($request, 'session_' . $sessionData['id']);
    }
    
    $results = $batch->execute();
    
    foreach ($results as $key => $result) {
        // Process batch results
    }
}
```

### Caching Calendar Data
```php
// ✅ DO: Cache frequently accessed calendar data
public function getUpcomingSessions(User $user): Collection {
    return Cache::remember(
        "user_{$user->id}_upcoming_sessions",
        300, // 5 minutes
        fn() => $this->fetchUpcomingSessionsFromGoogle($user)
    );
}
```

## Common Pitfalls to Avoid

```php
// ❌ DON'T: Forget conferenceDataVersion parameter
$this->service->events->insert($calendarId, $event); // Missing parameter

// ❌ DON'T: Use static request IDs
'requestId' => 'static_id' // Should be unique per request

// ❌ DON'T: Ignore token expiration
$this->client->setAccessToken($token); // Check if expired first

// ❌ DON'T: Block the main thread for API calls
$this->createGoogleCalendarEvent($data); // Use queued jobs instead

// ❌ DON'T: Store unencrypted sensitive data
'google_token' => $token // Should be encrypted
```

## Arabic Content Handling

### Localized Event Creation
```php
// ✅ DO: Create events with proper Arabic content
$event = new Google_Service_Calendar_Event([
    'summary' => "درس القرآن الكريم - سورة الفاتحة",
    'description' => "جلسة حفظ مع الأستاذ {$teacher->name}\nرابط الجلسة سيتم إرساله قبل الموعد بـ 15 دقيقة",
    'location' => 'منصة إتقان - جلسة افتراضية',
]);
```

### Timezone Handling for Arabic Regions
```php
// ✅ DO: Handle different timezones properly
public function createEventForAcademy(Academy $academy, array $eventData): Google_Service_Calendar_Event {
    $timezone = $academy->timezone ?? 'Asia/Riyadh';
    
    $event = new Google_Service_Calendar_Event([
        'start' => [
            'dateTime' => $eventData['start_time'],
            'timeZone' => $timezone
        ],
        'end' => [
            'dateTime' => $eventData['end_time'], 
            'timeZone' => $timezone
        ]
    ]);
    
    return $this->service->events->insert($academy->calendar_id, $event);
}
```

This guide ensures proper Google Calendar and Meet integration while maintaining security, performance, and Arabic language support.
description:
globs:
alwaysApply: false
---
