================================================================================
ITQAN PLATFORM - SESSIONS SYSTEM ARCHITECTURE DIAGRAM
================================================================================

1. SESSION MODEL INHERITANCE HIERARCHY
================================================================================

                          MeetingCapable (Interface)
                                  |
                                  |
                          BaseSession (Abstract)
                     ├─ Implements MeetingCapable
                     ├─ HasMeetings Trait
                     ├─ SoftDeletes Trait
                     └─ Common fields & relationships
                          /        |        \
                         /         |         \
                        /          |          \
            QuranSession    AcademicSession    InteractiveCourseSession
            ├─ individual   ├─ individual     ├─ course_id
            ├─ circle       ├─ interactive    ├─ session_number
            ├─ trial        └─ course         └─ scheduled_date/time
            └─ assessment      integration


2. SESSION STATUS FLOW
================================================================================

  [Create]
    |
    v
 UNSCHEDULED (Created, not scheduled)
    |
    | teacher schedules
    v
 SCHEDULED (Date/time set by teacher)
    |
    | auto-transition ~15 min before (system)
    v
 READY (Meeting created, prep time begins)
    |
    +---> CANCELLED (Teacher cancels) [Does NOT count subscription]
    |
    | first participant joins OR auto-complete with attendance
    v
 ONGOING (Session happening)
    |
    | auto-transition after duration + buffer (system)
    v
 COMPLETED (Successful completion) [COUNTS subscription]
    |
    +---> ABSENT (No-show, grace period expired) [COUNTS subscription]
          (Individual sessions only)


3. DATABASE TABLES STRUCTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ MAIN SESSION TABLES                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  quran_sessions                                                             │
│  ├─ id, academy_id, session_code (unique)                                  │
│  ├─ status (ENUM), title, description                                      │
│  ├─ scheduled_at, started_at, ended_at                                     │
│  ├─ duration_minutes, actual_duration_minutes                              │
│  ├─ meeting_link, meeting_id, meeting_room_name                            │
│  ├─ quran_teacher_id → User                                                │
│  ├─ quran_subscription_id → QuranSubscription                              │
│  ├─ circle_id → QuranCircle (group sessions)                               │
│  ├─ individual_circle_id → QuranIndividualCircle                           │
│  ├─ student_id → User (individual sessions)                                │
│  ├─ subscription_counted (boolean - prevent duplicates)                     │
│  └─ Quran-specific: current_surah, current_verse, papers_memorized, etc.   │
│                                                                             │
│  academic_sessions (similar structure to quran_sessions)                    │
│  ├─ academic_teacher_id → AcademicTeacherProfile                           │
│  ├─ session_grade, homework_description                                    │
│  └─ google_event_id, google_meet_url (Google Calendar integration)         │
│                                                                             │
│  interactive_course_sessions (different structure)                         │
│  ├─ course_id → InteractiveCourse                                          │
│  ├─ scheduled_date + scheduled_time (separate fields)                      │
│  ├─ session_number, attendance_count                                       │
│  └─ homework_assigned, materials_uploaded                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ATTENDANCE TRACKING TABLES                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  quran_session_attendances                                                  │
│  ├─ session_id, student_id                                                 │
│  ├─ attendance_status (present/absent/late)                                │
│  ├─ join_time, leave_time                                                  │
│  ├─ auto_tracked (true if from LiveKit)                                    │
│  ├─ participation_score (0-10)                                             │
│  └─ Quran metrics: recitation_quality, tajweed_accuracy, etc.              │
│                                                                             │
│  student_session_reports *** PRIMARY SOURCE OF TRUTH ***                   │
│  ├─ session_id, student_id, teacher_id                                     │
│  ├─ attendance_status (teacher-verified)                                   │
│  ├─ actual_attendance_minutes                                              │
│  ├─ is_auto_calculated (true if system-generated initially)                │
│  ├─ manually_overridden (true if teacher corrected)                        │
│  └─ evaluated_at (when report created/updated)                             │
│                                                                             │
│  academic_session_attendances (similar to Quran)                           │
│  academic_session_reports (comprehensive tracking)                         │
│                                                                             │
│  interactive_session_attendances                                            │
│  ├─ video_completion_percentage                                            │
│  ├─ quiz_completion, exercises_completed                                   │
│  └─ interaction_score                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SCHEDULING TABLES                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  session_schedules (for subscription/custom scheduling)                    │
│  ├─ academy_id, quran_teacher_id                                           │
│  ├─ schedule_code, recurrence_pattern                                      │
│  ├─ start_date, end_date, max_sessions                                     │
│  ├─ status (active/paused/completed)                                       │
│  └─ sessions_generated, sessions_completed, sessions_cancelled             │
│                                                                             │
│  quran_circle_schedules (for group circle sessions)                        │
│  ├─ circle_id, quran_teacher_id                                            │
│  ├─ weekly_schedule (JSON array)                                           │
│  ├─ monthly_sessions_count (sessions per month limit)                      │
│  ├─ generate_ahead_days, generate_before_hours                             │
│  └─ is_active (triggers auto-generation)                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


4. SESSION LIFECYCLE WORKFLOW
================================================================================

  CREATION
  ├─ Teacher/Admin creates session
  ├─ Set: academy, title, duration, session_type
  ├─ Auto-generate: session_code (unique per academy)
  └─ Status: UNSCHEDULED
         |
         v
  SCHEDULING (Teacher action)
  ├─ Set: scheduled_at timestamp
  ├─ Check: teacher has no conflicts
  ├─ Update: status → SCHEDULED
  └─ Record: teacher_scheduled_at, scheduled_by
         |
         v
  PREPARATION (Automatic ~15 min before)
  ├─ System checks: now >= scheduled_at - prep_minutes
  ├─ Create: LiveKit meeting room
  ├─ Update: status → READY, meeting_link, meeting_room_name
  └─ Log: preparation event
         |
         v
  ACTIVE SESSION (First participant joins)
  ├─ System checks: timing validation (within grace period)
  ├─ Update: status → ONGOING, started_at = now()
  ├─ LiveKit: tracks join/leave times in real-time
  └─ Log: session started
         |
         v
  COMPLETION (Auto ~duration + buffer after scheduled time)
  ├─ Option A: With attendance
  │  ├─ Update: status → COMPLETED, ended_at, actual_duration
  │  ├─ Close: LiveKit meeting room (prevents late joins)
  │  ├─ Update: subscription usage if applicable
  │  └─ Create: StudentSessionReport with metrics
  │
  ├─ Option B: No attendance (grace period expired)
  │  ├─ Update: status → ABSENT (individual sessions only)
  │  ├─ Update: subscription usage
  │  └─ Record: attendance as absent
  │
  └─ Create/Update: StudentSessionReport (primary attendance source)
         |
         v
  POST-SESSION
  ├─ Teacher views StudentSessionReport
  ├─ Optional: Teacher adjusts/overrides attendance
  ├─ Create: homework assignments if applicable
  ├─ Optional: Teacher adds feedback/grades
  └─ Optional: Student rates session


5. ATTENDANCE TRACKING WORKFLOW
================================================================================

  DURING SESSION
  ├─ LiveKit tracks: join_time, leave_time
  ├─ Record: MeetingAttendance (real-time, auto_tracked=true)
  ├─ Calculate: auto_duration_minutes, determine attendance_status
  └─ Status: temporary, auto-calculated
         |
         v
  SESSION COMPLETION
  ├─ Create: StudentSessionReport
  ├─ Status: initially same as MeetingAttendance (auto_calculated=true)
  ├─ Data source: LiveKit participant logs
  └─ Note: StudentSessionReport is comprehensive, MeetingAttendance is simple
         |
         v
  TEACHER REVIEW
  ├─ Teacher views StudentSessionReport
  ├─ Optional: Override attendance if discrepancies
  ├─ Update: manually_overridden = true, overridden_by, overridden_at
  ├─ Add: teacher comments, learning outcomes
  └─ Finalize: evaluated_at timestamp
         |
         v
  SUBSCRIPTION COUNTING
  ├─ Check: session status (COMPLETED or ABSENT counts)
  ├─ Check: StudentSessionReport attendance_status
  ├─ Lock: subscription_counted field (prevent race conditions)
  ├─ Update: subscription.sessions_used++
  └─ Record: subscription_counted = true on session


6. LIVEIT MEETING INTEGRATION
================================================================================

  STATUS: SCHEDULED
  ├─ No meeting yet
  └─ No join link available
         |
         v
  STATUS: READY (Auto 15 min before)
  ├─ Call: generateMeetingLink()
  ├─ Create: LiveKit room
  ├─ Store: meeting_room_name, meeting_link, meeting_data
  ├─ Store: meeting_expires_at, meeting_id, meeting_platform
  └─ Link ready for participants
         |
         v
  STATUS: ONGOING
  ├─ Room active, tracking participants
  ├─ Real-time: join/leave events recorded
  ├─ Query: getRoomInfo() - current status
  ├─ Query: isUserInMeeting(user) - participant check
  └─ Query: getMeetingStats() - stats
         |
         v
  STATUS: COMPLETED
  ├─ Call: closeMeeting() - **CRITICAL**
  ├─ Room disabled, no new joins allowed
  ├─ Save: final participant list & durations
  ├─ Update: meeting_data with final stats
  └─ Link still available for review (if configured)


7. KEY SERVICES & THEIR RESPONSIBILITIES
================================================================================

  SessionStatusService
  ├─ transitionToReady(session) - SCHEDULED → READY
  ├─ transitionToOngoing(session) - READY → ONGOING
  ├─ transitionToCompleted(session) - ONGOING/READY → COMPLETED
  ├─ transitionToAbsent(session) - READY → ABSENT
  ├─ transitionToCancelled(session, reason, cancelledBy) - → CANCELLED
  ├─ shouldTransitionToReady(session) - Check if ready for transition
  ├─ shouldTransitionToAbsent(session) - Check for no-show
  ├─ shouldAutoComplete(session) - Check for auto-completion
  └─ processStatusTransitions(sessions) - Batch process

  QuranSessionSchedulingService
  ├─ scheduleIndividualSession(template, scheduledAt, data)
  ├─ createGroupCircleSchedule(circle, weeklySchedule, startsAt, options)
  ├─ bulkScheduleIndividualSessions(circle, sessionsData)
  ├─ hasTeacherConflict(teacherId, scheduledAt, duration)
  ├─ getAvailableTimeSlots(teacherId, date, duration)
  └─ validateWeeklySchedule(schedule)

  SessionMeetingService / AcademicSessionMeetingService
  ├─ generateMeetingLink(session) - Create LiveKit room
  ├─ getMeetingInfo(session) - Retrieve meeting data
  ├─ isMeetingValid(session) - Check if still valid
  ├─ getMeetingJoinUrl(session) - Get join link
  ├─ generateParticipantToken(session, user, permissions) - Access token
  ├─ getRoomInfo(session) - Query current status
  ├─ closeMeeting(session) - End meeting (CRITICAL)
  └─ getMeetingStats(session) - Participant stats


8. CRITICAL BUSINESS RULES
================================================================================

  Subscription Counting
  ├─ ONLY statuses that count: COMPLETED, ABSENT
  ├─ Never recount same session: subscription_counted field
  ├─ Use lockForUpdate() to prevent race conditions
  └─ Check StudentSessionReport.attendance_status (primary source)

  Attendance Source of Truth
  ├─ StudentSessionReport is PRIMARY (teacher-verified)
  ├─ MeetingAttendance is SECONDARY (auto-calculated from LiveKit)
  ├─ Use StudentSessionReport if exists, fallback to MeetingAttendance
  ├─ Teacher can override with manually_overridden flag
  └─ Track overrides: overridden_by, overridden_at, override_reason

  Meeting Room Closure
  ├─ CRITICAL: Always close room when session completes
  ├─ Prevents: Late students from joining and inflating attendance
  ├─ Call: closeMeeting() BEFORE marking COMPLETED
  └─ Log: all closures for audit trail

  Teacher Availability
  ├─ Check: no overlapping sessions at scheduled time
  ├─ Conflict = any session touching the time window
  ├─ Include: duration_minutes in calculation
  └─ Prevent: double-booking (unless explicitly allowed)

  Timing Windows
  ├─ Before: Teacher 30 min early, Student 15 min early
  ├─ During: Based on status (READY, ONGOING)
  ├─ After: Teacher 2 hrs, Student 30 mins
  └─ Grace period: 15 mins after scheduled time for transitions


9. FIELDS BY SESSION TYPE
================================================================================

  Common to ALL (BaseSession)
  ├─ id, academy_id, session_code
  ├─ status, title, description
  ├─ scheduled_at, started_at, ended_at, duration_minutes
  ├─ meeting_link, meeting_id, meeting_room_name
  ├─ attendance_status, participants_count
  ├─ teacher_feedback, student_feedback, parent_feedback
  ├─ cancellation_reason, cancelled_by, cancelled_at
  └─ created_by, updated_by, scheduled_by

  QuranSession Additions
  ├─ current_surah, current_verse, current_page
  ├─ papers_memorized_today, verses_memorized_today
  ├─ recitation_quality, tajweed_accuracy
  ├─ recording_enabled, recording_url
  ├─ is_makeup_session, makeup_session_for
  ├─ subscription_counted (prevent double-counting)
  ├─ session_type (individual/circle/trial/assessment)
  └─ quran_teacher_id, student_id, circle_id

  AcademicSession Additions
  ├─ session_topics_covered, lesson_content
  ├─ session_grade, learning_outcomes
  ├─ homework_description, homework_file
  ├─ google_event_id, google_meet_url
  ├─ is_template, is_generated, is_scheduled
  └─ academic_teacher_id, academic_subscription_id

  InteractiveCourseSession Additions
  ├─ course_id, session_number
  ├─ scheduled_date, scheduled_time (separate from scheduled_at)
  ├─ attendance_count
  ├─ materials_uploaded, homework_assigned
  └─ homework_due_date, allow_late_submissions


10. ENUM: SessionStatus
================================================================================

  UNSCHEDULED → "غير مجدولة" (Gray, draft icon)
  ├─ canStart(): false
  ├─ canComplete(): false
  └─ countsTowardSubscription(): false

  SCHEDULED → "مجدولة" (Blue, calendar icon)
  ├─ canStart(): true
  ├─ canComplete(): true
  ├─ canCancel(): true
  ├─ canReschedule(): true
  └─ countsTowardSubscription(): false

  READY → "جاهزة للبدء" (Green, video icon)
  ├─ canStart(): true
  ├─ canComplete(): true
  ├─ canCancel(): true
  ├─ canReschedule(): true
  └─ countsTowardSubscription(): false

  ONGOING → "جارية الآن" (Green, live icon)
  ├─ canStart(): false
  ├─ canComplete(): true
  ├─ canCancel(): false
  └─ countsTowardSubscription(): false

  COMPLETED → "مكتملة" (Green, check circle icon)
  ├─ canStart(): false
  ├─ canComplete(): false
  ├─ canCancel(): false
  └─ countsTowardSubscription(): TRUE **

  CANCELLED → "ملغية" (Red, close circle icon)
  ├─ canStart(): false
  ├─ canComplete(): false
  ├─ canCancel(): false
  └─ countsTowardSubscription(): FALSE

  ABSENT → "غياب الطالب" (Red, user-x icon)
  ├─ canStart(): false
  ├─ canComplete(): false
  ├─ canCancel(): false
  └─ countsTowardSubscription(): TRUE ** (Individual sessions only)


11. RELATIONSHIP DIAGRAM: QuranSession
================================================================================

  QuranSession
  ├─ academy → Academy
  ├─ quranTeacher → User
  ├─ subscription → QuranSubscription
  ├─ circle → QuranCircle (group sessions)
  ├─ individualCircle → QuranIndividualCircle (individual sessions)
  ├─ student → User (individual sessions)
  ├─ trialRequest → QuranTrialRequest
  ├─ makeupFor → QuranSession (if is_makeup_session)
  ├─ makeupSessions → QuranSession (children)
  ├─ homework → QuranHomework (legacy)
  ├─ sessionHomework → QuranSessionHomework (new)
  ├─ homeworkAssignments → QuranHomeworkAssignment
  ├─ attendances → QuranSessionAttendance (1:many)
  ├─ studentReports → StudentSessionReport (1:many)
  ├─ meetingAttendances → MeetingAttendance (polymorphic, 1:many)
  ├─ cancelledBy → User
  ├─ createdBy → User
  ├─ updatedBy → User
  └─ scheduledBy → User


================================================================================
Document Version: 1.0
Generated: 2025-11-12
Purpose: Visual architecture reference for sessions system
================================================================================
