# Complete LiveKit Server Setup from Scratch (FIXED)

## Overview

This guide uses **LiveKit's official configuration generator** and recommended Docker setup for a production-ready LiveKit server with recording capabilities.

**Server**: 31.97.126.52
**Domain**: conference.itqanway.com
**Method**: Official LiveKit setup using `livekit/generate` tool

---

## Critical Fixes from Previous Attempts

✅ **Use LiveKit's official config generator** (not manual config)
✅ **Use `network_mode: host`** for simpler networking
✅ **Remove health check dependencies** that cause stuck containers
✅ **Minimal configuration** without unnecessary options
✅ **Proper config file paths** (`/etc/livekit.yaml`)

---

## Prerequisites

### 1. Verify DNS

```bash
# From your local machine
nslookup conference.itqanway.com
# Should return: 31.97.126.52

ping conference.itqanway.com
# Should ping: 31.97.126.52
```

### 2. SSH to Server

```bash
ssh root@31.97.126.52
```

---

## Step 1: Clean Up Previous Attempts

```bash
# Force stop everything
pkill -9 dockerd
pkill -9 containerd
sleep 5

# Restart Docker daemon
systemctl restart docker
sleep 10

# Remove everything from previous attempts
cd /opt/livekit 2>/dev/null || true
docker compose down -v 2>/dev/null || true
docker stop $(docker ps -aq) 2>/dev/null || true
docker rm -f $(docker ps -aq) 2>/dev/null || true
docker network prune -f
docker volume prune -f

# Verify clean slate
docker ps -a
# Should show nothing or only unrelated containers

# Remove old config directory
rm -rf /opt/livekit
```

---

## Step 2: Update System & Install Docker

```bash
# Update system
apt update && apt upgrade -y

# Install dependencies
apt install -y curl wget git nano htop net-tools ufw

# Remove old Docker
apt remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Install Docker Compose plugin
apt install -y docker-compose-plugin

# Verify installations
docker --version
docker compose version

# Enable Docker
systemctl enable docker
systemctl start docker

# Test Docker
docker run hello-world
# Should see: "Hello from Docker!"
```

---

## Step 3: Generate LiveKit Configuration (Official Method)

```bash
# Create project directory
mkdir -p /opt/livekit
cd /opt/livekit

# Run LiveKit's official configuration generator
docker run --rm -it -v $PWD:/output livekit/generate
```

**Answer the prompts:**

1. **Domain name**: `conference.itqanway.com`
2. **Do you want to use Let's Encrypt SSL?**: `yes`
3. **Email for Let's Encrypt**: `admin@itqanway.com`
4. **Do you want to use Redis?**: `yes`
5. **Do you want to use LiveKit Egress for recording?**: `yes`

This generates:
- `livekit.yaml` - LiveKit server configuration
- `caddy.yaml` - Caddy reverse proxy configuration (we'll adapt to Nginx)
- `docker-compose.yaml` - Docker Compose configuration
- `redis.conf` - Redis configuration

**Important**: The generator creates a working, tested configuration. We'll modify it for Nginx instead of Caddy.

---

## Step 4: Review Generated Configuration

**IMPORTANT**: The generator creates a subdirectory named after your domain!

```bash
# Navigate to the generated domain directory
cd /opt/livekit/conference.itqanway.com

# View generated LiveKit config
cat livekit.yaml

# View generated docker-compose
cat docker-compose.yaml

# View generated init script
cat init_script.sh

# List all generated files
ls -la
```

**Save the API credentials** from the generator output! You'll need them for Laravel.

The generated files include:
- `livekit.yaml` - LiveKit server configuration with generated API keys
- `docker-compose.yaml` - Complete Docker Compose setup
- `caddy.yaml` - Caddy configuration (we'll replace with Nginx)
- `init.sh` - Initialization script
- `.env` - Environment variables

---

## Step 5: Simplify Docker Compose (Replace Caddy with Nginx)

**Make sure you're in the domain directory:**

```bash
cd /opt/livekit/conference.itqanway.com
```

**Backup the generated file:**

```bash
cp docker-compose.yaml docker-compose.yaml.generated
```

**Create simplified `docker-compose.yaml`:**

```bash
cat > docker-compose.yaml <<'EOF'
# Simplified LiveKit Docker Compose
# Generated by: LiveKit official generator + Nginx adaptation
# Network mode: host (simpler, recommended by LiveKit)

services:
  redis:
    image: redis:7-alpine
    container_name: livekit-redis
    restart: unless-stopped
    network_mode: host
    command: redis-server --appendonly yes --bind 127.0.0.1
    volumes:
      - ./redis-data:/data

  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit-server
    restart: unless-stopped
    network_mode: host
    command: --config /etc/livekit.yaml --bind 0.0.0.0
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    depends_on:
      - redis

  egress:
    image: livekit/egress:latest
    container_name: livekit-egress
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./egress.yaml:/etc/egress.yaml:ro
      - ./recordings:/recordings
    environment:
      - EGRESS_CONFIG_FILE=/etc/egress.yaml
    cap_add:
      - SYS_ADMIN
    depends_on:
      - livekit

  nginx:
    image: nginx:alpine
    container_name: livekit-nginx
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./certbot/conf:/etc/letsencrypt:ro

  certbot:
    image: certbot/certbot:latest
    container_name: livekit-certbot
    volumes:
      - ./certbot/www:/var/www/certbot:rw
      - ./certbot/conf:/etc/letsencrypt:rw
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
EOF
```

---

## Step 6: Review Generated LiveKit Configuration

**The generator already created a working `livekit.yaml` for you!**

View it:

```bash
cd /opt/livekit/conference.itqanway.com
cat livekit.yaml
```

**Extract and save the API credentials** - you'll see them in the `keys:` section. They look like:

```yaml
keys:
    APIDATWRbyzZbxf: QcWYF4rTCJy9ekdsfW3bsgg1wpGUeWmsYtBIEoG12EGA
```

**Save these credentials** - you'll need them for Laravel later!

```bash
# Optional: Save credentials to a file for reference
cd /opt/livekit/conference.itqanway.com
grep -A 1 "keys:" livekit.yaml > credentials.txt
chmod 600 credentials.txt
```

---

## Step 7: Create Egress Configuration

```bash
cd /opt/livekit/conference.itqanway.com

cat > egress.yaml <<'EOF'
# LiveKit Egress Configuration
# Purpose: Recording interactive course sessions

# API Credentials (must match livekit.yaml)
api_key: APIxdLnkvjeS3PV
api_secret: coCkSrJcJmAKQcmODKd3qgCaa80YJSnrvGEDebrPAIJC

# LiveKit Server URL (localhost via host network)
ws_url: ws://127.0.0.1:7880

# Redis (localhost via host network)
redis:
  address: 127.0.0.1:6379

# Local file storage
file_output:
  local:
    enabled: true
    output_directory: /recordings

# Logging
log_level: info

# Health check
health_port: 9090

# Performance
cpu_cost:
  room_composite_cpu_cost: 3.0
EOF
```

---

## Step 8: Create Nginx Configuration

### Create directory structure:

```bash
cd /opt/livekit/conference.itqanway.com

mkdir -p certbot/{www,conf}
mkdir -p recordings
chmod 777 recordings
```

### Create Nginx config (HTTP only for Let's Encrypt first):

```bash
cat > nginx.conf <<'EOF'
# Nginx configuration for LiveKit
# Temporary HTTP-only for Let's Encrypt verification

events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # HTTP Server (for Let's Encrypt)
    server {
        listen 80;
        server_name conference.itqanway.com;

        # Let's Encrypt ACME challenge
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Temporary: Test endpoint
        location / {
            return 200 'Nginx is working! Ready for SSL setup.\n';
            add_header Content-Type text/plain;
        }
    }
}
EOF
```

---

## Step 9: Configure Firewall

```bash
# Enable firewall
ufw --force enable

# Allow SSH
ufw allow 22/tcp

# Allow HTTP (Let's Encrypt)
ufw allow 80/tcp

# Allow HTTPS
ufw allow 443/tcp

# Allow LiveKit HTTP API (optional)
ufw allow 7880/tcp

# Allow WebRTC
ufw allow 7881/tcp
ufw allow 50000:60000/udp

# Check status
ufw status verbose
```

---

## Step 10: Start Services (Testing Phase)

```bash
# Make sure you're in the domain directory
cd /opt/livekit/conference.itqanway.com

# Check memory first
free -h
# Should have 5GB+ available

# If low memory, drop caches
if [ $(free -m | awk 'NR==2{print $7}') -lt 5120 ]; then
  echo "Low memory detected, dropping caches..."
  sync
  echo 3 > /proc/sys/vm/drop_caches
  free -h
fi

# Start Redis first
docker compose up -d redis
sleep 5

# Test Redis
docker exec livekit-redis redis-cli ping
# Expected: PONG

# Start LiveKit (in FOREGROUND to see logs)
docker compose up livekit

# WATCH THE OUTPUT!
# You should see:
# INFO    starting LiveKit server    {"version": "..."}
# INFO    starting API server        {"port": 7880}
# INFO    rtc service started
```

**If you see those logs, press Ctrl+C and continue. If it hangs with NO output, there's a config error.**

---

## Step 11: Start All Services (Background)

**Only proceed if Step 10 showed logs successfully.**

```bash
cd /opt/livekit/conference.itqanway.com

# Start all services in background
docker compose up -d

# Wait for startup
sleep 15

# Check status
docker compose ps

# Expected output (all should be Up):
# NAME                IMAGE                          STATUS
# livekit-redis       redis:7-alpine                 Up X seconds
# livekit-server      livekit/livekit-server:latest  Up X seconds
# livekit-egress      livekit/egress:latest          Up X seconds
# livekit-nginx       nginx:alpine                   Up X seconds
# livekit-certbot     certbot/certbot:latest         Up X seconds
```

**Verify each service:**

```bash
# Test Redis
docker exec livekit-redis redis-cli ping
# Expected: PONG

# Test LiveKit
curl http://localhost:7880/
# Expected: 404 (normal - no root handler, but connection works)

# View LiveKit logs
docker logs livekit-server | tail -20
# Should see: "starting LiveKit server", "rtc service started"

# Test Nginx
curl http://localhost/
# Expected: "Nginx is working! Ready for SSL setup."

# Test from external (from your local machine)
curl http://31.97.126.52/
# or
curl http://conference.itqanway.com/
# Expected: "Nginx is working! Ready for SSL setup."
```

---

## Step 12: Obtain SSL Certificates

### Dry run first:

```bash
cd /opt/livekit/conference.itqanway.com

docker compose run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email admin@itqanway.com \
  --agree-tos \
  --no-eff-email \
  --dry-run \
  -d conference.itqanway.com

# Expected: "The dry run was successful"
```

### Get real certificates:

```bash
docker compose run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email admin@itqanway.com \
  --agree-tos \
  --no-eff-email \
  -d conference.itqanway.com

# Expected: "Successfully received certificate"
```

### Verify:

```bash
ls -la /opt/livekit/certbot/conf/live/conference.itqanway.com/
# Should show: fullchain.pem, privkey.pem
```

---

## Step 13: Update Nginx for HTTPS

```bash
cat > /opt/livekit/nginx.conf <<'EOF'
# Nginx configuration for LiveKit with SSL
# Production-ready HTTPS configuration

events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # HTTP -> HTTPS Redirect
    server {
        listen 80;
        server_name conference.itqanway.com;

        # Let's Encrypt ACME challenge
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Redirect to HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    # HTTPS Server
    server {
        listen 443 ssl http2;
        server_name conference.itqanway.com;

        # SSL Configuration
        ssl_certificate /etc/letsencrypt/live/conference.itqanway.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/conference.itqanway.com/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Proxy to LiveKit (localhost:7880 via host network)
        location / {
            proxy_pass http://127.0.0.1:7880;
            proxy_http_version 1.1;

            # WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_connect_timeout 60;
        }
    }
}
EOF

# Test Nginx config
docker exec livekit-nginx nginx -t
# Expected: "test is successful"

# Reload Nginx
docker compose restart nginx
```

---

## Step 14: Final Testing

### 1. Test HTTPS:

```bash
# From your local machine
curl -I https://conference.itqanway.com/
# Expected: HTTP/2 200 or 404 (connection works)

# Test SSL certificate
openssl s_client -connect conference.itqanway.com:443 -servername conference.itqanway.com < /dev/null | grep "Verify return code"
# Expected: Verify return code: 0 (ok)
```

### 2. Test from browser:

Open in browser: `https://conference.itqanway.com/`

You should see a 404 page (normal - no root handler), but with a **valid SSL certificate** (green lock icon).

### 3. Test Egress:

```bash
# SSH to server
ssh root@31.97.126.52

# Check Egress can connect to LiveKit
docker exec livekit-egress wget -qO- http://127.0.0.1:7880/ 2>/dev/null
# Should return response (even 404 is OK)

# Check Egress health
curl http://localhost:9090/
# Expected: healthy status or JSON response

# View Egress logs
docker logs livekit-egress | tail -20
# Should see: "connected to LiveKit", "connected to redis"
```

---

## Step 15: Update Laravel Configuration

Update your Laravel `.env`:

```bash
LIVEKIT_SERVER_URL=wss://conference.itqanway.com
LIVEKIT_API_URL=https://conference.itqanway.com
LIVEKIT_API_KEY=APIxdLnkvjeS3PV
LIVEKIT_API_SECRET=coCkSrJcJmAKQcmODKd3qgCaa80YJSnrvGEDebrPAIJC
```

**Test in Laravel:**

```bash
php artisan tinker

>>> $livekit = app(\App\Services\LiveKitService::class);
>>> $livekit->isConfigured();
# Should return: true

>>> $livekit->createMeeting(
...     \App\Models\Academy::first(),
...     'test',
...     123,
...     now()
... );
# Should create a room and return meeting data
```

---

## Troubleshooting

### If LiveKit container still won't start:

```bash
# 1. Check if config file is readable
docker run --rm -v /opt/livekit/livekit.yaml:/test.yaml alpine cat /test.yaml
# Should print the config content

# 2. Validate YAML syntax
docker run --rm -v /opt/livekit/livekit.yaml:/test.yaml alpine sh -c "apk add --no-cache yamllint && yamllint /test.yaml"

# 3. Check Docker daemon logs
journalctl -u docker --since "10 minutes ago" | grep -i livekit

# 4. Try without Redis first
# Edit livekit.yaml and comment out the redis section:
# #redis:
# #  address: 127.0.0.1:6379

# Then restart:
docker compose restart livekit
docker logs -f livekit-server
```

### If you still get stuck containers:

The issue is NOT configuration - it's Docker daemon corruption.

**Nuclear fix:**

```bash
# Stop everything
cd /opt/livekit/conference.itqanway.com
docker compose down

# Force kill Docker
pkill -9 dockerd
pkill -9 containerd

# Reboot server
reboot

# Wait 2 minutes, SSH back in
ssh root@31.97.126.52

# Start fresh
cd /opt/livekit/conference.itqanway.com
docker compose up -d
```

---

## Monitoring & Maintenance

### View logs:

```bash
# All services
docker compose logs -f

# Specific service
docker logs -f livekit-server
docker logs -f livekit-egress
```

### Restart services:

```bash
cd /opt/livekit/conference.itqanway.com
docker compose restart
```

### Update services:

```bash
cd /opt/livekit/conference.itqanway.com
docker compose pull
docker compose up -d
```

### Clean up recordings (older than 30 days):

```bash
find /opt/livekit/conference.itqanway.com/recordings -name "*.mp4" -type f -mtime +30 -delete
```

---

## Sources & References

- [LiveKit Official VM Deployment Guide](https://docs.livekit.io/home/self-hosting/vm/)
- [LiveKit Configuration Sample (GitHub)](https://github.com/livekit/livekit/blob/master/config-sample.yaml)
- [LiveKit Docker Hub](https://hub.docker.com/r/livekit/livekit-server)
- [LiveKit Configuration Not Loading Issue #749](https://github.com/livekit/livekit/issues/749)

---

## Summary

This setup uses:

✅ **LiveKit's official recommended approach**
✅ **`network_mode: host`** for simpler networking (no port mapping issues)
✅ **Minimal configuration** from official sample
✅ **No complex health checks** that cause stuck containers
✅ **Let's Encrypt SSL** with auto-renewal
✅ **LiveKit Egress** for recording to local storage

**Total memory usage:** ~2-3GB (leaves 28GB+ free on your 31GB server)

**Everything runs on `https://conference.itqanway.com` with valid SSL!**
