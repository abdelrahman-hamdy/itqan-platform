<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <meta name="user-id" content="1">
    <title>Enhanced Chat System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-success { background: #d1fae5; color: #065f46; }
        .log-error { background: #fee2e2; color: #991b1b; }
        .log-info { background: #dbeafe; color: #1e40af; }
        .log-warning { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Enhanced Chat System Test</h1>

        <!-- Connection Status -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Connection Status</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded">
                    <div class="text-sm text-gray-600 mb-1">Pusher</div>
                    <div id="pusher-status" class="font-bold text-red-500">Not Loaded</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded">
                    <div class="text-sm text-gray-600 mb-1">Echo</div>
                    <div id="echo-status" class="font-bold text-red-500">Not Loaded</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded">
                    <div class="text-sm text-gray-600 mb-1">WebSocket</div>
                    <div id="ws-status" class="font-bold text-yellow-500">Connecting...</div>
                </div>
            </div>
        </div>

        <!-- Enhanced Chat Features -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Enhanced Features Test</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">‚úÖ Real-time Connection</h3>
                    <div id="feature-realtime" class="text-sm text-gray-600">Testing...</div>
                </div>
                <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">‚å®Ô∏è Typing Indicators</h3>
                    <div id="feature-typing" class="text-sm text-gray-600">Testing...</div>
                </div>
                <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">üì¨ Message Status</h3>
                    <div id="feature-status" class="text-sm text-gray-600">Testing...</div>
                </div>
                <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">üë• Presence</h3>
                    <div id="feature-presence" class="text-sm text-gray-600">Testing...</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Actions</h2>
            <div class="flex gap-4 flex-wrap">
                <button onclick="testConnection()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Test Connection
                </button>
                <button onclick="testTyping()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    Test Typing
                </button>
                <button onclick="testNotifications()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    Test Notifications
                </button>
                <button onclick="testOffline()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                    Test Offline
                </button>
                <button onclick="clearLogs()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Clear Logs
                </button>
            </div>
        </div>

        <!-- Console Log -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Console Log</h2>
            <div id="console-log" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto">
                <div class="log-entry log-info">System initialized. Waiting for tests...</div>
            </div>
        </div>
    </div>

    <!-- Load Pusher -->
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

    <!-- Load Laravel Echo -->
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.16.1/dist/echo.iife.js"></script>

    <script>
        // Logging helper
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('console-log').innerHTML = '';
            log('Logs cleared', 'info');
        }

        // Check library loading
        function checkLibraries() {
            if (typeof Pusher !== 'undefined') {
                document.getElementById('pusher-status').textContent = 'Loaded ‚úì';
                document.getElementById('pusher-status').className = 'font-bold text-green-500';
                log('‚úÖ Pusher library loaded successfully', 'success');
            } else {
                document.getElementById('pusher-status').textContent = 'Failed ‚úó';
                log('‚ùå Pusher library failed to load', 'error');
            }

            if (typeof Echo !== 'undefined') {
                document.getElementById('echo-status').textContent = 'Loaded ‚úì';
                document.getElementById('echo-status').className = 'font-bold text-green-500';
                log('‚úÖ Laravel Echo loaded successfully', 'success');
            } else {
                document.getElementById('echo-status').textContent = 'Failed ‚úó';
                log('‚ùå Laravel Echo failed to load', 'error');
            }
        }

        // Test WebSocket connection
        function testConnection() {
            log('üîå Testing WebSocket connection to Reverb...', 'info');

            try {
                const ws = new WebSocket('ws://localhost:8085/app/vil71wafgpp6do1miwn1?protocol=7');

                ws.onopen = () => {
                    log('‚úÖ WebSocket connection successful!', 'success');
                    document.getElementById('ws-status').textContent = 'Connected ‚úì';
                    document.getElementById('ws-status').className = 'font-bold text-green-500';
                    document.getElementById('feature-realtime').textContent = 'Working ‚úì';
                    document.getElementById('feature-realtime').className = 'text-sm text-green-600';
                    ws.close();
                };

                ws.onerror = (error) => {
                    log('‚ùå WebSocket connection failed: ' + error.message, 'error');
                    document.getElementById('ws-status').textContent = 'Failed ‚úó';
                    document.getElementById('ws-status').className = 'font-bold text-red-500';
                };

                ws.onclose = () => {
                    log('WebSocket connection closed', 'info');
                };

            } catch (error) {
                log('‚ùå Error testing connection: ' + error.message, 'error');
            }
        }

        // Test typing indicators
        function testTyping() {
            log('‚å®Ô∏è Testing typing indicators...', 'info');

            if (typeof window.enhancedChat !== 'undefined') {
                window.enhancedChat.handleTypingInput();
                log('‚úÖ Typing indicator triggered', 'success');
                document.getElementById('feature-typing').textContent = 'Working ‚úì';
                document.getElementById('feature-typing').className = 'text-sm text-green-600';
            } else {
                log('‚ùå Enhanced chat system not initialized', 'error');
                document.getElementById('feature-typing').textContent = 'Not Ready ‚úó';
                document.getElementById('feature-typing').className = 'text-sm text-red-600';
            }
        }

        // Test notifications
        function testNotifications() {
            log('üîî Testing notification system...', 'info');

            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('Test Notification', {
                            body: 'Enhanced chat system is working!',
                            icon: '/images/chat-badge.png'
                        });
                        log('‚úÖ Notification sent successfully', 'success');
                    } else {
                        log('‚ö†Ô∏è Notification permission denied', 'warning');
                    }
                });
            } else {
                log('‚ùå Notifications not supported in this browser', 'error');
            }
        }

        // Test offline support
        function testOffline() {
            log('üì¥ Testing offline support...', 'info');

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        log('‚úÖ Service Worker registered: ' + registrations.length + ' worker(s)', 'success');
                    } else {
                        log('‚ö†Ô∏è No service workers registered', 'warning');
                        log('Attempting to register service worker...', 'info');
                        navigator.serviceWorker.register('/sw-chat.js')
                            .then(() => log('‚úÖ Service Worker registered successfully', 'success'))
                            .catch(error => log('‚ùå Service Worker registration failed: ' + error.message, 'error'));
                    }
                });
            } else {
                log('‚ùå Service Workers not supported', 'error');
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            log('üöÄ Initializing enhanced chat system tests...', 'info');
            checkLibraries();

            // Auto-test connection after 1 second
            setTimeout(() => {
                log('Running auto-test...', 'info');
                testConnection();
            }, 1000);

            // Check if enhanced chat is initialized
            setTimeout(() => {
                if (window.enhancedChat) {
                    log('‚úÖ Enhanced Chat System detected!', 'success');
                    document.getElementById('feature-status').textContent = 'Ready ‚úì';
                    document.getElementById('feature-status').className = 'text-sm text-green-600';
                } else {
                    log('‚ÑπÔ∏è Enhanced Chat System not initialized (expected on test page)', 'info');
                }
            }, 2000);
        });
    </script>
</body>
</html>