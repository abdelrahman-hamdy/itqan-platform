@props(['session'])

<!-- Student Evaluation Modal -->
<div id="studentEvaluationModal"
     x-data="{ open: false }"
     x-show="open"
     x-cloak
     @open-evaluation-modal.window="open = true"
     @close-evaluation-modal.window="open = false"
     @keydown.escape.window="if(open) { open = false; }"
     class="fixed inset-0 z-50 overflow-y-auto"
     role="dialog"
     aria-modal="true">

    <!-- Background overlay -->
    <div x-show="open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="open = false"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>

    <!-- Modal Container - Bottom sheet on mobile, centered on desktop -->
    <div class="fixed inset-0 flex items-end md:items-center justify-center p-0 md:p-4">
        <!-- Modal panel -->
        <div x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-full md:translate-y-0 md:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 md:scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 md:scale-100"
             x-transition:leave-end="opacity-0 translate-y-full md:translate-y-0 md:scale-95"
             @click.stop
             class="relative bg-white w-full md:max-w-2xl rounded-t-2xl md:rounded-2xl shadow-xl max-h-[90vh] md:max-h-[85vh] flex flex-col overflow-hidden">

            <!-- Mobile drag handle -->
            <div class="md:hidden absolute top-2 left-1/2 -translate-x-1/2 w-10 h-1 rounded-full bg-gray-300 z-10"></div>

            <!-- Header -->
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-100 flex-shrink-0 pt-6 md:pt-6">
                <h3 id="evaluationModalTitle" class="text-lg md:text-xl font-bold text-gray-900">{{ __('components.modals.student_evaluation.title') }}</h3>
                <button @click="open = false"
                        id="closeEvaluationModalBtn"
                        class="p-2 min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 transition-colors">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>

            <!-- Scrollable Form Body -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6">
                <form id="studentEvaluationForm" class="space-y-5">
                    @csrf
                    <input type="hidden" id="evalStudentId" name="student_id">
                    <input type="hidden" id="evalReportId" name="report_id">

                    <!-- Student Info Display -->
                    <div id="studentInfoDisplay" class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div id="studentAvatarDisplay" class="flex-shrink-0"></div>
                            <div class="min-w-0 flex-1">
                                <h4 id="studentNameDisplay" class="font-semibold text-gray-900 truncate"></h4>
                                <p id="attendanceInfoDisplay" class="text-sm text-gray-600 truncate"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Degrees -->
                    <div id="homeworkDegreeFields" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div id="newMemorizationDegreeField" class="hidden">
                            <label for="newMemorizationDegree" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ __('components.modals.student_evaluation.new_memorization_degree') }}
                            </label>
                            <input type="number"
                                   id="newMemorizationDegree"
                                   name="new_memorization_degree"
                                   min="0"
                                   max="10"
                                   step="0.5"
                                   class="w-full px-4 py-3 min-h-[48px] text-base border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div id="reviewDegreeField" class="hidden">
                            <label for="reservationDegree" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ __('components.modals.student_evaluation.review_degree') }}
                            </label>
                            <input type="number"
                                   id="reservationDegree"
                                   name="reservation_degree"
                                   min="0"
                                   max="10"
                                   step="0.5"
                                   class="w-full px-4 py-3 min-h-[48px] text-base border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Attendance Status Override -->
                    <div>
                        <label for="attendanceStatus" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ __('components.modals.student_evaluation.attendance_status') }}
                        </label>
                        <select id="attendanceStatus"
                                name="attendance_status"
                                class="w-full px-4 py-3 min-h-[48px] text-base border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">{{ __('components.modals.student_evaluation.keep_auto_calculated') }}</option>
                            @foreach(\App\Enums\AttendanceStatus::cases() as $status)
                                <option value="{{ $status->value }}">{{ $status->label() }}</option>
                            @endforeach
                        </select>
                        <p class="text-xs text-gray-500 mt-1">{{ __('components.modals.student_evaluation.keep_auto_note') }}</p>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="evaluationNotes" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ __('components.modals.student_evaluation.evaluation_notes') }}
                        </label>
                        <textarea id="evaluationNotes"
                                  name="notes"
                                  rows="4"
                                  class="w-full px-4 py-3 min-h-[120px] text-base border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="أضف ملاحظاتك حول أداء الطالب..."></textarea>
                    </div>
                </form>
            </div>

            <!-- Fixed Footer -->
            <div class="flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-end gap-3 p-4 md:p-6 border-t border-gray-100 bg-gray-50 flex-shrink-0">
                <button type="button" id="cancelEvaluationBtn"
                        @click="open = false"
                        class="inline-flex items-center justify-center min-h-[48px] sm:min-h-[44px] px-6 py-3 sm:py-2 text-base sm:text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-xl sm:rounded-lg transition-colors">
                    إلغاء
                </button>
                <button type="submit" form="studentEvaluationForm"
                        class="inline-flex items-center justify-center min-h-[48px] sm:min-h-[44px] px-6 py-3 sm:py-2 text-base sm:text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white rounded-xl sm:rounded-lg transition-colors">
                    حفظ التقييم
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
</style>

<script>
    // Student management functions
    function changeStudentStatus(studentId) {
        showNotification('تغيير حالة الطالب قيد التطوير', 'info');
    }

    // Student evaluation modal functions - Compatible with Alpine.js
    function editStudentReport(studentId, reportId) {
        const form = document.getElementById('studentEvaluationForm');

        // Set hidden fields
        document.getElementById('evalStudentId').value = studentId;
        document.getElementById('evalReportId').value = reportId || '';

        // Reset form
        form.reset();
        document.getElementById('evalStudentId').value = studentId;
        document.getElementById('evalReportId').value = reportId || '';

        // Load current data if editing existing report
        if (reportId && reportId !== 'null') {
            loadExistingReportData(reportId);
        } else {
            // Load student basic info for new report
            loadStudentBasicInfo(studentId);
        }

        // Dispatch Alpine.js event to open modal
        window.dispatchEvent(new CustomEvent('open-evaluation-modal'));
        document.body.style.overflow = 'hidden';
    }

    function loadExistingReportData(reportId) {
        fetch(`{{ url('/') }}/teacher/student-reports/${reportId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const report = data.report;

                    // Store report data globally for attendance status listener
                    window.currentReportData = report;

                    // Fill form fields
                    document.getElementById('newMemorizationDegree').value = report.new_memorization_degree || '';
                    document.getElementById('reservationDegree').value = report.reservation_degree || '';
                    document.getElementById('evaluationNotes').value = report.notes || '';

                    // Set attendance status if manually set
                    if (report.manually_evaluated) {
                        document.getElementById('attendanceStatus').value = report.attendance_status || '';
                    } else {
                        document.getElementById('attendanceStatus').value = '';
                    }

                    // Update student info display
                    updateStudentInfoDisplay(report.student, report);

                    // Update auto-calculated attendance info
                    updateAutoAttendanceInfo(report);

                    // Load homework fields for existing report
                    loadHomeworkFields();
                }
            })
            .catch(error => {
                showNotification('خطأ في تحميل بيانات التقرير', 'error');
            });
    }

    function loadStudentBasicInfo(studentId) {
        fetch(`{{ url('/') }}/teacher/students/${studentId}/basic-info`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStudentInfoDisplay(data.student, null);
                    // Load homework data to show conditional fields
                    loadHomeworkFields();
                }
            })
            .catch(error => {
            });
    }

    function loadHomeworkFields() {
        fetch(`{{ url('/') }}/teacher/sessions/{{ $session->id }}/homework`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.homework) {
                    const homework = data.homework;

                    // Show/hide fields based on homework configuration
                    const newMemField = document.getElementById('newMemorizationDegreeField');
                    const reviewField = document.getElementById('reviewDegreeField');

                    if (homework.has_new_memorization) {
                        newMemField.classList.remove('hidden');
                    } else {
                        newMemField.classList.add('hidden');
                    }

                    // Show review field if either regular review OR comprehensive review is assigned
                    if (homework.has_review || homework.has_comprehensive_review) {
                        reviewField.classList.remove('hidden');
                    } else {
                        reviewField.classList.add('hidden');
                    }
                } else {
                    // No homework, hide all degree fields
                    document.getElementById('newMemorizationDegreeField').classList.add('hidden');
                    document.getElementById('reviewDegreeField').classList.add('hidden');
                }
            })
            .catch(error => {
                // On error, hide fields
                document.getElementById('newMemorizationDegreeField').classList.add('hidden');
                document.getElementById('reviewDegreeField').classList.add('hidden');
            });
    }

    function updateStudentInfoDisplay(student, report = null) {
        document.getElementById('studentNameDisplay').textContent = student.name;

        // Update avatar
        const avatarDiv = document.getElementById('studentAvatarDisplay');
        avatarDiv.innerHTML = `
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
                ${student.name.charAt(0)}
            </div>
        `;

        // Update attendance info
        let attendanceText = 'بدون معلومات حضور';
        if (report) {
            attendanceText = `الحضور: ${getAttendanceStatusArabic(report.attendance_status)}`;
            if (report.attendance_percentage) {
                attendanceText += ` (${Math.round(report.attendance_percentage)}%)`;
            }
        }
        document.getElementById('attendanceInfoDisplay').textContent = attendanceText;
    }

    function updateAutoAttendanceInfo(report) {
        const autoEnterTime = document.getElementById('autoEnterTime');
        const autoLeaveTime = document.getElementById('autoLeaveTime');
        const autoAttendanceMinutes = document.getElementById('autoAttendanceMinutes');
        const autoAttendancePercentage = document.getElementById('autoAttendancePercentage');

        if (autoEnterTime) {
            autoEnterTime.textContent = report.meeting_enter_time ? new Date(report.meeting_enter_time).toLocaleTimeString('ar-SA') : '-';
        }
        if (autoLeaveTime) {
            autoLeaveTime.textContent = report.meeting_leave_time ? new Date(report.meeting_leave_time).toLocaleTimeString('ar-SA') : '-';
        }
        if (autoAttendanceMinutes) {
            autoAttendanceMinutes.textContent = report.actual_attendance_minutes || '-';
        }
        if (autoAttendancePercentage) {
            autoAttendancePercentage.textContent = report.attendance_percentage ? Math.round(report.attendance_percentage) : '-';
        }
    }

    function getAttendanceStatusArabic(status) {
        const statusMap = {
            'attended': 'حاضر',
            'late': 'متأخر',
            'left': 'غادر مبكراً',
            'absent': 'غائب'
        };
        return statusMap[status] || 'غير محدد';
    }

    // Modal event handlers - Using Alpine.js for open/close
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('studentEvaluationForm');

        // Note: Close button and backdrop click are now handled by Alpine.js

        // Attendance status change listener
        const attendanceStatusSelect = document.getElementById('attendanceStatus');
        attendanceStatusSelect?.addEventListener('change', function(e) {
            const selectedStatus = e.target.value;
            const attendanceInfoDisplay = document.getElementById('attendanceInfoDisplay');

            if (attendanceInfoDisplay) {
                if (selectedStatus) {
                    attendanceInfoDisplay.textContent = `الحضور: ${getAttendanceStatusArabic(selectedStatus)} (يدوي)`;
                } else {
                    const currentStudentId = document.getElementById('studentId')?.value;
                    if (window.currentReportData && window.currentReportData.attendance_status) {
                        attendanceInfoDisplay.textContent = `الحضور: ${getAttendanceStatusArabic(window.currentReportData.attendance_status)}`;
                        if (window.currentReportData.attendance_percentage) {
                            attendanceInfoDisplay.textContent += ` (${Math.round(window.currentReportData.attendance_percentage)}%)`;
                        }
                    } else {
                        attendanceInfoDisplay.textContent = 'الحضور: بدون معلومات حضور';
                    }
                }
            }
        });

        // Form submission
        form?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`{{ url('/') }}/teacher/student-reports/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: JSON.stringify({
                        ...data,
                        session_id: {{ $session->id }}
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('تم حفظ التقييم بنجاح', 'success');

                    // Update the student card in place instead of reloading (to preserve LiveKit connection)
                    const studentId = data.student_id;
                    if (result.report && typeof updateStudentCardDisplay === 'function') {
                        updateStudentCardDisplay(studentId, result.report);
                    }

                    // Update the local cache if it exists
                    if (typeof window.currentReportData !== 'undefined') {
                        window.currentReportData = result.report;
                    }

                    // Close modal after short delay
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('close-evaluation-modal'));
                        document.body.style.overflow = '';
                    }, 800);
                } else {
                    showNotification(result.message || 'خطأ في حفظ التقييم', 'error');
                }
            } catch (error) {
                showNotification('خطأ في حفظ التقييم', 'error');
            }
        });
    });

    function viewStudentReport(studentId) {
        showNotification('تقرير الطالب قيد التطوير', 'info');
    }

    function messageStudent(studentId) {
        const subdomain = '{{ request()->route("subdomain") ?? auth()->user()->academy->subdomain ?? "itqan-academy" }}';
        const chatUrl = '/chat?user=' + studentId;
        window.location.href = chatUrl;
    }

    // Notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;

        const colors = {
            info: 'bg-blue-500 text-white',
            success: 'bg-green-500 text-white',
            warning: 'bg-yellow-500 text-white',
            error: 'bg-red-500 text-white'
        };

        notification.className += ` ${colors[type] || colors.info}`;
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="ri-information-line"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white opacity-70 hover:opacity-100">
                    <i class="ri-close-line"></i>
                </button>
            </div>
        `;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 5000);
    }
</script>
